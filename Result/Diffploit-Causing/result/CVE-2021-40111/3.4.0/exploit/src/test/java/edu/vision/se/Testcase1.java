package edu.vision.se;

import static org.assertj.core.api.Assertions.assertThatThrownBy;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.util.Base64;

import org.apache.james.protocols.imap.DecodingException;
import org.apache.james.imap.decode.ImapRequestStreamLineReader;
import org.apache.james.imap.decode.parser.StatusCommandParser;
import org.apache.james.imap.encode.FakeImapSession;
import org.apache.james.imap.message.response.UnpooledStatusResponseFactory;
import org.junit.Test;

import java.nio.charset.StandardCharsets;
import org.apache.james.imap.api.ImapCommand;
import org.apache.james.imap.api.process.ImapSession;
import org.apache.james.imap.decode.ImapRequestLineReader;


public class Testcase1 {
    @Test(timeout = 10000)
    public void fuzzingInputShouldNotLeadToOutOfMemoryException() {
        String base64Input = "MiAgKH8MSU4kQiBOJEIgICMAf15Df39/f39/f39/f39/f39/f39/f39/f0NDRTogP19GbT8JCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCQkJCT0NAAAAAAAAAD0/TkNPAAAAAAhlAAAAAAA=";
        byte[] bytes = Base64.getDecoder().decode(base64Input);

        assertThatThrownBy(() -> new StatusCommandParserChild(new UnpooledStatusResponseFactory())
                .decode(new ImapRequestStreamLineReader(new ByteArrayInputStream(bytes),
                        "AEA", new FakeImapSession()))
                .isInstanceOf(DecodingException.class);
    }
}

class StatusCommandParserChild extends StatusCommandParser {
    public StatusCommandParserChild(UnpooledStatusResponseFactory statusResponseFactory) {
        super();
    }

    public void decode(ImapRequestStreamLineReader request, String tag, FakeImapSession session) throws DecodingException {
        super.decode(ImapCommand.anyStateCommand("STATUS"), request, tag, session);
    }
}
